# Behavior Analysis Automation and Graph Generation

This repository contains four Python scripts to automate the creation of behavioral data sheets and generate summary graphs for rat cohorts in cocaine and oxycodone experiments. The scripts are:

* **cocaine\_behavior\_sheet\_automation.py**: Builds and populates an Excel "Behavior Data" sheet for cocaine cohorts.
* **graph\_cocaine.py**: Reads the generated Cocaine Behavior sheet and creates cohort- and rat-level summary graphs in PDF format.
* **oxy\_behavior\_sheet\_automation.py**: Builds and populates an Excel "Behavior Data" sheet for oxycodone cohorts.
* **graph\_oxy.py**: Reads the generated Oxycodone Behavior sheet (plus additional Tail Immersion and Von Frey data) and creates summary graphs in PDF format.

---

## Prerequisites

* Python 3.7 or above
* Excel files generated by the data acquisition pipeline:

  * Cocaine cohort Excel outputs: `excel_output_files/COCAINE/<subfolder>/*_output.xlsx`
  * Oxycodone cohort Excel outputs: `excel_output_files/OXYCODONE/<subfolder>/*_output.xlsx`
* Cohort metadata Excel files:

  * Cocaine: `Cocaine Cohort Information/Cocaine C<XX> Updated Cohort Information.xlsx`
  * Oxycodone: `Oxy Cohort Information/Oxycodone C<XX> Updated Cohort Information.xlsx`
* (For Oxy graphs) Tail Immersion: `Tail Immersion/Oxy_C<XX>_TailImmersion.xlsx`
* (For Oxy graphs) Von Frey: `Von Frey/Oxy_C<XX>_VonFrey.xlsx`

### Python Libraries

All scripts use the following libraries (install via `pip install`):

* `pandas` — Data manipulation and reading Excel files.
* `numpy` — Numeric operations and array handling.
* `openpyxl` — Reading, writing, and modifying Excel workbooks.
* `matplotlib` — Plotting graphs and generating PDF outputs.
* `re` (built-in) — Regular expressions for parsing session names.
* `datetime` (built-in) — Date parsing and handling (in sheet automation scripts).

Additionally, `graph_cocaine.py` and `oxy_graph_generation.py` use:

* `matplotlib.gridspec` — Advanced subplot layouts.
* `matplotlib.backends.backend_pdf.PdfPages` — Saving multiple figures to a single PDF.
* `matplotlib.ticker` and `matplotlib.patches.Rectangle` — Axis formatting and title boxes.

---

## 1. `cocaine_behavior_sheet_automation.py`

Automates the creation of a "Behavior Data" sheet for Cocaine cohorts:

1. **Configuration**:

   * Set `cohort_number` (integer) at the top of `main()`.
   * The script constructs file paths for:

     * Behavior sheet: `Cocaine_C<XX>_behavior_sheet.xlsx` in the Behavior Sheet Auto folder.
     * Cohort metadata: `Cocaine C<XX> Updated Cohort Information.xlsx` in the Cohort Information folder.
     * Daily issues: `Coc_C<XX>_Issues.xlsx`.
     * Raw session outputs: Excel files in subfolders `["LGA","SHA","PR","SHOCK"]` under `excel_output_files/COCAINE`.

2. **Workflow**:

   * **Load or create** the behavior workbook and clear any existing "Behavior Data" sheet.
   * **Add headers** for Date, Session Name, and section labels (Rewards, Active Lever Presses, Inactive Lever Presses).
   * **Copy rats** (Rat ID, RFID, Drug Group, Experiment Group) from the metadata "Timeline" sheet.
   * **Collect exit information** (Exit Day, Exit Code, Exit Notes, Last Good Session) from the metadata "Exit Tab" sheet.
   * **Discover sessions** by scanning output filenames matching `HSCOC<session>_output.xlsx` in each subfolder.
   * **Append session columns** (session names and dates).
   * **Fill data** for each session by reading each session’s output file:

     * Rewards
     * Active Lever Presses
     * Inactive Lever Presses

3. **Functions**:

   * `sort_columns_by_date()` — (Optional) Sorts session columns by date and rewrites the sheet.
   * `find_or_create_section()` — Locates or creates a section heading row in the sheet.

**Usage**:

```bash
python cocaine_behavior_sheet_automation.py
```

---

## 2. `graph_cocaine.py`

Generates PDF graphs from the Cocaine Behavior sheet:

1. **Configuration**:

   * Set `COHORT` (string or integer) at the top.
   * File paths for:

     * Behavior sheet: `.xlsx` file produced by the automation script.
     * Cohort metadata file.
     * Output PDF for graphs.

2. **Workflow**:

   * **Read** the "Behavior Data" sheet with `pandas.read_excel(header=None)`.
   * **Parse**:

     * Metadata rows (dates, session names, issues, notes).
     * Behavior sections (Rewards, Active Lever Presses, Inactive Lever Presses).
   * **Load cohort info** to match Rat IDs with metadata (coat color, dissection group).
   * **Compute cohort averages** (overall, male, female) by session group:

     * SHA, LGA, PR, Shock.
   * **Create pages**:

     1. Cohort averages (4 rows × 3 columns of plots).
     2. Overlay all rats for each measure.
     3. Detail page per rat, including exit codes and last good session.
   * **Save** all figures to a multi-page PDF using `PdfPages`.

3. **Helper Functions**:

   * `extract_day()` — Extracts numeric day from a session name (regex).
   * `parse_daily_issue()` — Flags if an issue applies to a rat on a session.
   * `extract_section()` — Slices the DataFrame into sections by heading.
   * `extract_meta_row()` — Retrieves notes row metadata.

**Usage**:

```bash
python graph_cocaine.py
```

---

## 3. `oxy_behavior_sheet_automation.py`

Similar to the cocaine version, but for Oxycodone cohorts:

1. **Configuration**:

   * Set `cohort_number` at the top of `main()`.
   * Paths for:

     * Behavior sheet: `Oxycodone_C<XX>_behavior_sheet.xlsx`.
     * Cohort info: `Oxycodone C<XX> Updated Cohort Information.xlsx`.
     * Daily issues: `Oxy_<XX>_Issues.xlsx`.
     * Raw outputs in `excel_output_files/OXYCODONE/` with subfolders `["LGA","SHA","PR"]`.

2. **Workflow**:

   * Mirror of the cocaine script, with adjustments:

     * No SHOCK folder.
     * Session filename pattern `HSOXY<session>_output.xlsx`.
     * Includes the same sections: Rewards, Active Lever Presses, Inactive Lever Presses.
     * Copies Experiment Group from metadata.

3. **Functions**:

   * `sort_columns_by_date()` — Sort session columns by date.
   * `find_or_create_section()` — Locate or make section headings.

**Usage**:

```bash
python oxy_behavior_sheet_automation.py
```

---

## 4. `graph_oxy.py`

Generates PDF graphs from the Oxycodone Behavior sheet plus Tail Immersion and Von Frey tests:

1. **Configuration**:

   * Set `COHORT` at the top.
   * Paths for:

     * Behavior sheet: `Oxycodone_C<COHORT>_behavior_sheet.xlsx`.
     * Tail Immersion file: `Oxy_C<COHORT>_TailImmersion.xlsx`.
     * Von Frey file: `Oxy_C<COHORT>_VonFrey.xlsx`.
     * Cohort metadata file.

2. **Workflow**:

   * **Read** behavior sheet and parse metadata as in `graph_cocaine.py`.
   * **Load** optional pain-sensitivity tests:

     * Tail Immersion times per trial.
     * Von Frey forces per trial.
   * **Compute**:

     * Cohort averages for behavior measures.
     * Cohort averages for Tail Immersion and Von Frey.
   * **Plot**:

     1. Page with cohort averages (behavior + pain tests).
     2. Overlay all rats for each behavior measure and individual tests.
     3. Per-rat detailed pages (behavior + pain tests).
   * **Save** to multi-page PDF.

3. **Helper Functions**:

   * `extract_day()`, `parse_daily_issue()`, `extract_section()`, `extract_meta_row()` — similar logic as in `graph_cocaine.py`.

**Usage**:

```bash
python oxy_graph_generation.py
```

---

## Contributing

* Ensure consistency in file paths; consider refactoring common logic into shared modules.
* Add logging and error handling for missing files or unexpected sheet formats.
* Update this documentation when modifying configuration parameters or workflows.

---
